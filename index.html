<script>
    // ... (keep all previous dataStore and elements declarations)

    async function loadDataFromGist() {
      const gistId = elements.gistId.value.trim();
      const token = elements.githubToken.value.trim();
      
      if (!gistId) {
        showGitHubStatus('Please enter a Gist ID', 'error');
        return;
      }
      
      try {
        showGitHubStatus('Loading data from Gist...', 'info');
        
        const url = `https://api.github.com/gists/${gistId}`;
        const headers = {
          'Accept': 'application/vnd.github.v3+json'
        };
        
        // REQUIRED: Add Authorization header if token exists
        if (token) {
          headers['Authorization'] = `Bearer ${token}`; // Changed to Bearer token
        } else {
          // For public gists, we need to handle potential rate limits
          headers['If-None-Match'] = '"' + Math.random().toString(36) + '"'; // Cache buster
        }
        
        const response = await fetch(url, { headers });
        
        if (!response.ok) {
          if (response.status === 401) {
            throw new Error('Authentication failed. Please check your GitHub token and ensure it has "gist" scope.');
          } else if (response.status === 403) {
            throw new Error('Rate limit exceeded. Please add a GitHub token to authenticate.');
          } else if (response.status === 404) {
            throw new Error('Gist not found. Check the ID or ensure it exists.');
          } else {
            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
          }
        }
        
        const gistData = await response.json();
        const files = Object.values(gistData.files);
        
        if (files.length === 0) {
          throw new Error('Gist contains no files');
        }
        
        // Find first JSON file
        const jsonFile = files.find(f => f.filename.endsWith('.json'));
        if (!jsonFile) {
          throw new Error('No JSON data file found in Gist');
        }
        
        // Get raw URL for the content
        const rawUrl = jsonFile.raw_url;
        const rawResponse = await fetch(rawUrl);
        if (!rawResponse.ok) {
          throw new Error('Failed to fetch raw Gist content');
        }
        
        const fileContent = await rawResponse.text();
        const parsedData = JSON.parse(fileContent);
        
        // Validate data structure
        if (!parsedData || typeof parsedData !== 'object') {
          throw new Error('Invalid data format in Gist');
        }
        
        // Merge data carefully
        Object.keys(parsedData).forEach(key => {
          if (dataStore.hasOwnProperty(key)) {
            if (Array.isArray(dataStore[key])) {
              dataStore[key] = [...parsedData[key]];
            } else if (typeof dataStore[key] === 'object') {
              Object.assign(dataStore[key], parsedData[key]);
            } else {
              dataStore[key] = parsedData[key];
            }
          }
        });
        
        showGitHubStatus('Data loaded successfully!', 'success');
        loadInitialData();
      } catch (error) {
        showGitHubStatus(`Error: ${error.message}`, 'error');
        console.error('Gist load error:', error);
      }
    }

    async function saveDataToGist() {
      const gistId = elements.gistId.value.trim();
      const token = elements.githubToken.value.trim();
      
      if (!token) {
        showGitHubStatus('GitHub token required to save data', 'error');
        return;
      }
      
      try {
        showGitHubStatus('Saving data...', 'info');
        
        const filename = `afprs-backup-${new Date().toISOString().slice(0,10)}.json`;
        const content = JSON.stringify(dataStore, null, 2);
        
        const gistData = {
          description: 'AFPRS Data Backup',
          public: false,
          files: {
            [filename]: {
              content: content
            }
          }
        };
        
        const method = gistId ? 'PATCH' : 'POST';
        const url = gistId ? `https://api.github.com/gists/${gistId}` : 'https://api.github.com/gists';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github.v3+json'
          },
          body: JSON.stringify(gistData)
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          let message = `GitHub API error: ${response.status}`;
          if (errorData.message) {
            message += ` - ${errorData.message}`;
          }
          throw new Error(message);
        }
        
        const result = await response.json();
        if (!gistId) {
          elements.gistId.value = result.id;
        }
        
        showGitHubStatus(`Data saved successfully! Gist ID: ${result.id}`, 'success');
      } catch (error) {
        showGitHubStatus(`Save failed: ${error.message}`, 'error');
        console.error('Gist save error:', error);
      }
    }

    // ... (rest of your existing code)
</script>
