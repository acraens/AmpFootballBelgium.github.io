<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Previous head content remains exactly the same -->
  <!-- ... -->
</head>
<body>
  <!-- Previous HTML content remains exactly the same -->
  <!-- ... -->

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Previous dataStore and elements declarations remain the same
    // ...

    // GitHub Gist Functions - UPDATED with proper error handling
    async function loadDataFromGist() {
      const gistId = elements.gistId.value.trim();
      const token = elements.githubToken.value.trim();
      
      if (!gistId) {
        showGitHubStatus('Please enter a Gist ID', 'error');
        return;
      }
      
      try {
        showGitHubStatus('Loading data from Gist...', 'info');
        
        const url = `https://api.github.com/gists/${gistId}`;
        const headers = {
          'Accept': 'application/vnd.github.v3+json'
        };
        
        // Only add Authorization header if token exists
        if (token) {
          headers['Authorization'] = `token ${token}`;
        }
        
        const response = await fetch(url, { headers });
        
        if (!response.ok) {
          // More detailed error handling
          if (response.status === 401) {
            throw new Error('Unauthorized - Check your GitHub token');
          } else if (response.status === 404) {
            throw new Error('Gist not found - Check the Gist ID');
          } else {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
        }
        
        const gistData = await response.json();
        const files = Object.values(gistData.files);
        
        if (files.length === 0) {
          throw new Error('No files found in Gist');
        }
        
        // Find the first JSON file
        const jsonFile = files.find(file => file.filename.endsWith('.json'));
        if (!jsonFile) {
          throw new Error('No JSON file found in Gist');
        }
        
        const fileContent = jsonFile.content;
        const parsedData = JSON.parse(fileContent);
        
        // Validate the loaded data structure
        if (!parsedData.players || !parsedData.users) {
          throw new Error('Invalid data format in Gist');
        }
        
        // Merge the loaded data with our existing dataStore
        Object.keys(parsedData).forEach(key => {
          if (dataStore.hasOwnProperty(key)) {
            dataStore[key] = parsedData[key];
          }
        });
        
        showGitHubStatus('Data loaded successfully!', 'success');
        loadInitialData();
      } catch (error) {
        showGitHubStatus(`Error: ${error.message}`, 'error');
        console.error('Error loading from Gist:', error);
      }
    }

    async function saveDataToGist() {
      const gistId = elements.gistId.value.trim();
      const token = elements.githubToken.value.trim();
      
      if (!gistId && !token) {
        showGitHubStatus('To create a new Gist, you need a GitHub token', 'error');
        return;
      }
      
      if (!token) {
        showGitHubStatus('A GitHub token is required to save data', 'error');
        return;
      }
      
      try {
        showGitHubStatus('Saving data to Gist...', 'info');
        
        const filename = `afprs-data-${new Date().toISOString().split('T')[0]}.json`;
        const content = JSON.stringify(dataStore, null, 2);
        
        const gistData = {
          description: 'AFPRS Data Backup',
          public: false,
          files: {
            [filename]: {
              content: content
            }
          }
        };
        
        let url, method;
        if (gistId) {
          url = `https://api.github.com/gists/${gistId}`;
          method = 'PATCH';
        } else {
          url = 'https://api.github.com/gists';
          method = 'POST';
        }
        
        const response = await fetch(url, {
          method,
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github.v3+json'
          },
          body: JSON.stringify(gistData)
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            throw new Error('Invalid GitHub token - Please check your token');
          } else if (response.status === 404 && gistId) {
            throw new Error('Gist not found - Check the Gist ID');
          } else {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
        }
        
        const result = await response.json();
        
        if (!gistId) {
          // If we created a new gist, update the Gist ID field
          elements.gistId.value = result.id;
        }
        
        showGitHubStatus('Data saved successfully!', 'success');
      } catch (error) {
        showGitHubStatus(`Error: ${error.message}`, 'error');
        console.error('Error saving to Gist:', error);
      }
    }

    // Rest of the code remains exactly the same
    // ...
  </script>
</body>
</html>
