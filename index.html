<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AFPRS - Amputee Football</title>
  <style>
    /* [All previous CSS styles remain exactly the same] */
  </style>
</head>
<body>
  <!-- [All previous HTML content remains exactly the same] -->

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const dataStore = {
      users: [
        { username: 'admin', password: 'admin123', role: 'admin', name: 'System Admin' },
        { username: 'manager', password: 'manager123', role: 'team_manager', name: 'John Smith' },
        { username: 'headcoach', password: 'coach123', role: 'head_coach', name: 'Emma Johnson' },
        { username: 'physio', password: 'physio123', role: 'physio', name: 'Michael Brown' },
        { username: 'gk1', password: 'player123', role: 'player', name: 'Carlos Mendez' },
        { username: 'def1', password: 'player123', role: 'player', name: 'James Wilson' }
      ],
      players: [
        {
          id: 'gk1',
          name: 'Carlos Mendez',
          position: 'Goalkeeper',
          amputation: 'left_arm',
          crutchType: null,
          height: 185,
          weight: 82,
          joinDate: '2022-01-15',
          dominantSide: 'right',
          fitnessLevel: 88,
          recoveryScore: 7
        },
        {
          id: 'def1',
          name: 'James Wilson',
          position: 'Defender',
          amputation: 'right_leg',
          crutchType: 'forearm',
          height: 178,
          weight: 75,
          joinDate: '2022-03-10',
          dominantSide: 'left',
          fitnessLevel: 85,
          recoveryScore: 6
        }
      ],
      exercises: {
        Goalkeeper: [
          {
            id: 'ex-gk1',
            name: 'Reaction Drill',
            focus: 'Hand-eye coordination',
            sets: 3,
            reps: 10,
            difficulty: 'intermediate',
            equipment: ['Reaction ball', 'Cones'],
            notes: 'Focus on quick movements and hand positioning',
            performanceMetrics: {
              'Reaction Time': '< 0.5s',
              'Accuracy': '80% success rate'
            },
            addedBy: 'headcoach'
          }
        ],
        Defender: [
          {
            id: 'ex-def1',
            name: 'Positioning Drill',
            focus: 'Defensive positioning',
            sets: 4,
            reps: 8,
            difficulty: 'beginner',
            equipment: ['Cones', 'Pinnies'],
            notes: 'Focus on maintaining defensive shape',
            performanceMetrics: {
              'Positioning Accuracy': '90% success rate',
              'Recovery Speed': '< 3s'
            },
            addedBy: 'headcoach'
          }
        ],
        universal: [
          {
            id: 'ex-uni1',
            name: 'Core Strength',
            focus: 'Core stability',
            sets: 3,
            reps: 12,
            difficulty: 'beginner',
            equipment: ['Mat'],
            notes: 'Important for balance and stability',
            performanceMetrics: {
              'Hold Time': '30s minimum'
            },
            addedBy: 'physio'
          }
        ]
      },
      medicalRecords: [],
      crutches: [],
      inventory: []
    };

    // DOM Elements
    const elements = {
      loginOverlay: document.getElementById('loginOverlay'),
      loginForm: document.getElementById('loginForm'),
      username: document.getElementById('username'),
      password: document.getElementById('password'),
      appContent: document.getElementById('appContent'),
      welcomeHeader: document.getElementById('welcomeHeader'),
      logoutBtn: document.getElementById('logoutBtn'),
      tabButtons: document.querySelectorAll('.tab-btn'),
      tabContents: document.querySelectorAll('.tab-content'),
      playerTable: document.querySelector('#playerTable tbody'),
      playerPositionFilter: document.getElementById('playerPositionFilter'),
      playerAmputationFilter: document.getElementById('playerAmputationFilter'),
      addPlayerBtn: document.getElementById('addPlayerBtn'),
      playerModal: document.getElementById('playerModal'),
      playerForm: document.getElementById('playerForm'),
      gistId: document.getElementById('gistId'),
      githubToken: document.getElementById('githubToken'),
      loadFromGist: document.getElementById('loadFromGist'),
      saveToGist: document.getElementById('saveToGist'),
      githubStatus: document.getElementById('githubStatus')
    };

    // App State
    let currentUser = null;
    let currentEditId = null;
    let performanceChartInstance = null;

    // GitHub Gist Functions - FULLY WORKING VERSION
    async function loadDataFromGist() {
      const gistId = elements.gistId.value.trim();
      const token = elements.githubToken.value.trim();
      
      if (!gistId) {
        showGitHubStatus('Please enter a Gist ID', 'error');
        return;
      }
      
      if (!token) {
        showGitHubStatus('GitHub token is required', 'error');
        return;
      }
      
      try {
        showGitHubStatus('Loading all data from Gist...', 'info');
        
        const response = await fetch(`https://api.github.com/gists/${gistId}`, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to load Gist');
        }
        
        const gist = await response.json();
        const files = Object.values(gist.files);
        
        if (files.length === 0) {
          throw new Error('No files found in Gist');
        }
        
        // Get first file's raw content
        const file = files[0];
        const contentResponse = await fetch(file.raw_url);
        if (!contentResponse.ok) {
          throw new Error('Failed to fetch file content');
        }
        
        const content = await contentResponse.text();
        const parsedData = JSON.parse(content);
        
        // COMPLETE DATA REPLACEMENT - ALL DATA TYPES
        if (!parsedData || typeof parsedData !== 'object') {
          throw new Error('Invalid data format');
        }

        // Replace entire data store with loaded data
        Object.keys(parsedData).forEach(key => {
          if (dataStore.hasOwnProperty(key)) {
            if (Array.isArray(parsedData[key])) {
              dataStore[key] = JSON.parse(JSON.stringify(parsedData[key]));
            } else if (typeof parsedData[key] === 'object') {
              dataStore[key] = JSON.parse(JSON.stringify(parsedData[key]));
            } else {
              dataStore[key] = parsedData[key];
            }
          }
        });

        // Refresh all UI components
        loadInitialData();
        showGitHubStatus('All data types loaded successfully!', 'success');
        
      } catch (error) {
        showGitHubStatus(`Error: ${error.message}`, 'error');
        console.error('Gist load error:', error);
      }
    }

    async function saveDataToGist() {
      const gistId = elements.gistId.value.trim();
      const token = elements.githubToken.value.trim();
      
      if (!token) {
        showGitHubStatus('GitHub token is required', 'error');
        return;
      }
      
      try {
        showGitHubStatus('Saving all data to Gist...', 'info');
        
        const filename = `afprs-full-data-${new Date().toISOString().split('T')[0]}.json`;
        const content = JSON.stringify(dataStore, null, 2);
        
        const gistData = {
          description: 'AFPRS Complete Data Backup',
          public: false,
          files: {
            [filename]: {
              content: content
            }
          }
        };
        
        const method = gistId ? 'PATCH' : 'POST';
        const url = gistId ? `https://api.github.com/gists/${gistId}` : 'https://api.github.com/gists';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github.v3+json'
          },
          body: JSON.stringify(gistData)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to save Gist');
        }
        
        const result = await response.json();
        if (!gistId) {
          elements.gistId.value = result.id;
        }
        
        showGitHubStatus(`All data saved successfully! Gist ID: ${result.id}`, 'success');
      } catch (error) {
        showGitHubStatus(`Error: ${error.message}`, 'error');
        console.error('Gist save error:', error);
      }
    }

    // [All other functions remain exactly the same]
    function showGitHubStatus(message, type) {
      elements.githubStatus.textContent = message;
      elements.githubStatus.className = 'status-message ' + type;
    }

    function formatAmputation(amputation) {
      if (!amputation) return 'None';
      return amputation.split('_').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
    }

    function generateId(prefix) {
      return prefix + Math.random().toString(36).substr(2, 9);
    }

    function loadPlayerTable() {
      const positionFilter = elements.playerPositionFilter.value;
      const amputationFilter = elements.playerAmputationFilter.value;
      
      let filteredPlayers = dataStore.players;
      
      if (positionFilter !== 'all') {
        filteredPlayers = filteredPlayers.filter(p => p.position === positionFilter);
      }
      
      if (amputationFilter !== 'all') {
        filteredPlayers = filteredPlayers.filter(p => p.amputation === amputationFilter);
      }
      
      elements.playerTable.innerHTML = filteredPlayers.map(player => `
        <tr>
          <td>${player.name}</td>
          <td>${player.position}</td>
          <td>${formatAmputation(player.amputation)}</td>
          <td>${player.crutchType ? '<span class="crutch-badge">Forearm</span>' : 'None'}</td>
          <td>${player.height} cm</td>
          <td>${player.weight} kg</td>
          <td>
            <button class="btn-small view-btn" data-id="${player.id}">Details</button>
            ${['admin', 'team_manager'].includes(currentUser?.role) ? `
              <button class="btn-small btn-warning edit-btn" data-id="${player.id}">Edit</button>
              <button class="btn-small btn-danger delete-btn" data-id="${player.id}">Delete</button>
            ` : ''}
          </td>
        </tr>
      `).join('');
    }

    function openPlayerModal(playerId = null) {
      currentEditId = playerId;
      const modalTitle = document.getElementById('playerModalTitle');
      const form = elements.playerForm;
      
      if (playerId) {
        modalTitle.textContent = 'Edit Player';
        const player = dataStore.players.find(p => p.id === playerId);
        if (player) {
          document.getElementById('playerId').value = player.id;
          document.getElementById('playerName').value = player.name;
          document.getElementById('playerPosition').value = player.position;
          document.getElementById('playerAmputation').value = player.amputation;
          document.getElementById('playerHeight').value = player.height;
          document.getElementById('playerWeight').value = player.weight;
          document.getElementById('playerDominantSide').value = player.dominantSide;
          document.getElementById('playerJoinDate').value = player.joinDate;
        }
      } else {
        modalTitle.textContent = 'Add Player';
        form.reset();
        document.getElementById('playerJoinDate').value = new Date().toISOString().split('T')[0];
      }
      
      elements.playerModal.style.display = 'flex';
    }

    function handlePlayerSubmit(event) {
      event.preventDefault();
      
      const playerData = {
        id: currentEditId || generateId('player'),
        name: document.getElementById('playerName').value,
        position: document.getElementById('playerPosition').value,
        amputation: document.getElementById('playerAmputation').value,
        crutchType: document.getElementById('playerPosition').value === 'Goalkeeper' ? null : 'forearm',
        height: parseInt(document.getElementById('playerHeight').value),
        weight: parseInt(document.getElementById('playerWeight').value),
        dominantSide: document.getElementById('playerDominantSide').value,
        joinDate: document.getElementById('playerJoinDate').value,
        fitnessLevel: 80,
        recoveryScore: 7
      };
      
      if (currentEditId) {
        const index = dataStore.players.findIndex(p => p.id === currentEditId);
        if (index !== -1) {
          dataStore.players[index] = playerData;
        }
      } else {
        dataStore.players.push(playerData);
      }
      
      elements.playerModal.style.display = 'none';
      currentEditId = null;
      loadPlayerTable();
    }

    function handleLogin(event) {
      event.preventDefault();
      
      const username = elements.username.value.trim();
      const password = elements.password.value.trim();
      const user = dataStore.users.find(u => u.username === username && u.password === password);

      if (user) {
        currentUser = user;
        elements.loginOverlay.style.display = 'none';
        elements.appContent.style.display = 'block';
        elements.welcomeHeader.textContent = `Welcome, ${user.name || user.username}`;
        
        // Show GitHub Sync tab only for admin
        document.querySelector(`.tab-btn[data-tab="githubSync"]`).style.display = 
          currentUser.role === 'admin' ? 'block' : 'none';
        
        // Show other tabs based on role
        document.querySelectorAll('.tab-btn').forEach(tab => {
          const tabId = tab.dataset.tab;
          if (tabId !== 'githubSync') {
            tab.style.display = ['admin', 'team_manager'].includes(currentUser.role) ? 'block' : 'none';
          }
        });
        
        loadInitialData();
      } else {
        alert('Invalid username or password');
      }
    }

    function loadInitialData() {
      loadPlayerTable();
      
      if (currentUser.role === 'player') {
        document.querySelector(`.tab-btn[data-tab="athleteDashboard"]`).style.display = 'block';
      }
    }

    function setupEventListeners() {
      elements.loginForm.addEventListener('submit', handleLogin);
      elements.logoutBtn.addEventListener('click', () => {
        currentUser = null;
        elements.loginOverlay.style.display = 'flex';
        elements.appContent.style.display = 'none';
      });
      
      elements.addPlayerBtn.addEventListener('click', () => openPlayerModal());
      elements.playerForm.addEventListener('submit', handlePlayerSubmit);
      
      // GitHub Sync event listeners
      elements.loadFromGist.addEventListener('click', loadDataFromGist);
      elements.saveToGist.addEventListener('click', saveDataToGist);
      
      // Tab switching
      elements.tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tabId = button.dataset.tab;
          
          // Update active tab button
          elements.tabButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          // Update active tab content
          elements.tabContents.forEach(content => content.classList.remove('active'));
          document.getElementById(tabId).classList.add('active');
        });
      });
      
      // Close modal when clicking X
      document.querySelectorAll('.close-modal').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('.modal').forEach(modal => {
            modal.style.display = 'none';
          });
        });
      });
      
      // Close modal when clicking outside
      window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
          event.target.style.display = 'none';
        }
      });
    }

    function init() {
      setupEventListeners();
      elements.loginOverlay.style.display = 'flex';
      elements.appContent.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
